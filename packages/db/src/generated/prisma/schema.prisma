model Developer {
  id       String @unique @default(uuid())
  username String @id @unique

  runs  Run[]
  token String @unique

  growwApiKey    String? /// @encrypted
  growwApiSecret String? /// @encrypted 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token, username])
  @@map("developers")
}

model Run {
  id String @id @default(uuid())

  startTime DateTime
  endTime   DateTime

  completed Boolean    @default(false)
  orders    Order[]
  developer Developer? @relation(fields: [developerId], references: [id], onDelete: Cascade)

  name String?
  tags String[] @default([])

  developerId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([startTime, endTime, completed])
  @@map("runs")
}

model Order {
  id String @id @default(uuid())

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  nseSymbol       String
  stopLossPrice   Decimal
  takeProfitPrice Decimal
  entryPrice      Decimal
  timestamp       DateTime

  runId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([runId, nseSymbol])
  @@map("orders")
}

model NseIntrument {
  id     String @id @default(uuid())
  symbol String @unique
  name   String

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  candles   NseCandle[]

  @@index([symbol])
  @@map("nse_instruments")
}

model NseCandle {
  id String @id @default(uuid())

  instrument NseIntrument @relation(fields: [instrumentId], references: [id])
  timestamp  DateTime
  open       Decimal
  high       Decimal
  low        Decimal
  close      Decimal
  volume     BigInt

  instrumentId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([instrumentId, timestamp])
  @@map("nse_candles")
}

model NseHoliday {
  id   String   @id @default(uuid())
  date DateTime @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@map("nse_holidays")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ShortlistSnapshot {
  id            String         @id @default(uuid())
  timestamp     DateTime
  shortlistType ShortlistType
  entries       Json // Array of shortlist items with nseSymbol, name, price
  scope         ShortlistScope @default(TOP_5) // we store both the entire shortlist as well as the top 5 which are quote fetched

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt

  @@index([timestamp])
  @@map("shortlist_snapshots")
}

enum ShortlistType {
  TOP_GAINERS
  VOLUME_SHOCKERS
}

enum ShortlistScope {
  FULL
  TOP_5
}

model CollectorError {
  id           String   @id @default(uuid())
  timestamp    DateTime
  errorMessage String
  errorStack   String?
  errorContext Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timestamp])
  @@map("collector_errors")
}
